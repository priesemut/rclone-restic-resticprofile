name: Scheduled Version Check & Build

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Get Latest Upstream Versions
        id: versions
        run: |
          get_version() {
            local repo=$1
            curl -s "https://api.github.com/repos/${repo}/releases/latest" | jq -r .tag_name | sed 's/v//'
          }

          RCLONE=$(get_version "rclone/rclone")
          RESTIC=$(get_version "restic/restic")
          RESTICPROFILE=$(get_version "creativeprojects/resticprofile")

          echo "Found versions: Rclone=$RCLONE, Restic=$RESTIC, Resticprofile=$RESTICPROFILE"

          # Validierung
          if [[ -z "$RESTIC" || "$RESTIC" == "null" || -z "$RCLONE" || "$RCLONE" == "null" || -z "$RESTICPROFILE" || "$RESTICPROFILE" == "null" ]]; then
            echo "Error. Unable to get one or more versions."
            exit 1
          fi

          echo "rclone=$RCLONE" >> $GITHUB_OUTPUT
          echo "restic=$RESTIC" >> $GITHUB_OUTPUT
          echo "resticprofile=$RESTICPROFILE" >> $GITHUB_OUTPUT
          echo "combined=${RCLONE}_${RESTIC}_${RESTICPROFILE}" >> $GITHUB_OUTPUT
          
      - name: Stop if this version was already built (release tag exists)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="image-${{ steps.versions.outputs.combined }}"
          API="${{ github.api_url }}/repos/${{ github.repository }}/releases/tags/${TAG}"

          echo "Checking if release exists for tag: ${TAG}"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "${API}")

          if [ "${STATUS}" = "200" ]; then
            echo "Release already exists. Skipping build/push."
            echo "NEW_BUILD=false" >> "$GITHUB_ENV"
            exit 0
          fi

          if [ "${STATUS}" != "404" ]; then
            echo "Unexpected status while checking release: ${STATUS}"
            exit 1
          fi

          echo "No release found yet. Proceeding with build."
          echo "NEW_BUILD=true" >> "$GITHUB_ENV"

      - name: Set up QEMU
        if: env.NEW_BUILD == 'true'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: env.NEW_BUILD == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        if: env.NEW_BUILD == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push
        if: env.NEW_BUILD == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          build-args: |
            RCLONE_VERSION=${{ steps.versions.outputs.rclone }}
            RESTIC_VERSION=${{ steps.versions.outputs.restic }}
            RESTICPROFILE_VERSION=${{ steps.versions.outputs.resticprofile }}
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/rclone-restic-resticprofile:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/rclone-restic-resticprofile:${{ steps.versions.outputs.combined }}

      - name: Create GitHub Release (notify on successful new image)
        if: success() && env.NEW_BUILD == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: image-${{ steps.versions.outputs.combined }}
          name: "Image built: ${{ steps.versions.outputs.combined }}"
          body: |
            A new Docker image was built and pushed.

            Version: ${{ steps.versions.outputs.combined }}
            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
  
